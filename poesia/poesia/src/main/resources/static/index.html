<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versos del Alma | Colecci√≥n de Poes√≠a</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-color: #fff5f8;
            --text-color: #543d41;
            --accent-color: #d67c93;
            --accent-hover: #b8657a;
            --secondary-color: #a39094;
            --card-bg: #ffffff;
            --card-border: #ffe6ee;
            --card-shadow: 0 15px 35px rgba(214, 124, 147, 0.15);
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Lato', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-sans);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: linear-gradient(to bottom, #fffbfd 0%, #fff5f8 100%);
        }

        /* HEADER */
        header { padding: 2rem 5%; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: var(--font-serif); font-size: 1.6rem; font-weight: 700; color: var(--accent-color); text-decoration: none; cursor: pointer; }
        .nav-actions { display: flex; gap: 15px; align-items: center; }

        .btn-outline, .btn-solid { padding: 8px 20px; border-radius: 30px; cursor: pointer; font-weight: 700; transition: all 0.3s; text-decoration: none; font-size: 0.9rem; border: 2px solid var(--accent-color); }
        .btn-outline { background: transparent; color: var(--accent-color); }
        .btn-outline:hover { background: var(--accent-color); color: white; }
        .btn-solid { background: var(--accent-color); color: white; }
        .btn-solid:hover { background: var(--accent-hover); border-color: var(--accent-hover); transform: translateY(-2px); }
        .user-welcome { font-family: var(--font-serif); font-style: italic; color: var(--text-color); margin-right: 10px; }

        /* RESTO DEL DISE√ëO */
        .hero { text-align: center; padding: 4rem 1rem; max-width: 800px; margin: 0 auto; }
        .hero h1 { font-family: var(--font-serif); font-size: 4rem; margin-bottom: 1rem; font-style: italic; color: var(--text-color); }
        .hero p { color: var(--secondary-color); font-size: 1.15rem; }

        .filters { display: flex; justify-content: center; gap: 25px; margin-bottom: 3.5rem; }
        .filter-btn { border: none; background: none; cursor: pointer; font-size: 1rem; color: var(--secondary-color); padding-bottom: 8px; position: relative; font-family: var(--font-sans); }
        .filter-btn:hover, .filter-btn.active { color: var(--accent-color); font-weight: 700; }
        .filter-btn.active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background: var(--accent-color); border-radius: 2px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem 5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 45px; }

        .card { background: var(--card-bg); padding: 2.5rem; border-radius: 12px; box-shadow: var(--card-shadow); transition: all 0.4s ease; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; min-height: 380px; border: 1px solid var(--card-border); position: relative; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 20px 45px rgba(214, 124, 147, 0.25); border-color: #ffd1e0; }

        .card-tag { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--secondary-color); margin-bottom: 1.5rem; display: flex; justify-content: space-between; font-weight: 700; align-items: center; }
        .premium-badge { color: var(--accent-color); background: #fff0f4; padding: 2px 8px; border-radius: 10px; }
        .card h2 { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 1rem; line-height: 1.15; color: var(--text-color); }
        .card-preview { font-family: var(--font-serif); color: #7a676a; font-size: 1.05rem; margin-bottom: 2rem; flex-grow: 1; white-space: pre-line; overflow: hidden; max-height: 160px; position: relative; font-style: italic; }
        .card-preview::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: linear-gradient(transparent, var(--card-bg)); }
        .card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--card-border); padding-top: 1.2rem; }
        .read-btn { font-size: 0.9rem; font-weight: 700; color: var(--secondary-color); transition: color 0.3s; }
        .card:hover .read-btn { color: var(--accent-color); }

        /* ESTILO PARA EL BOT√ìN DE BORRAR */
        .delete-btn {
            background: none; border: none; color: #ffadad;
            cursor: pointer; font-size: 1.1rem; transition: color 0.3s; z-index: 10;
        }
        .delete-btn:hover { color: #d32f2f; }

        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 245, 248, 0.97); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.4s ease; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: #fff; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 3rem; box-shadow: 0 25px 70px rgba(214, 124, 147, 0.2); position: relative; text-align: center; border-radius: 16px; border: 1px solid var(--card-border); }
        .modal-content.wide { max-width: 700px; padding: 4rem; }

        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 2rem; cursor: pointer; background: none; border: none; color: var(--accent-color); }
        .modal-title { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 1.5rem; color: var(--text-color); }

        .form-group { margin-bottom: 1.2rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; font-size: 0.9rem; color: var(--text-color); }
        .form-input, .form-textarea { width: 100%; padding: 12px; border: 2px solid var(--card-border); font-family: var(--font-sans); border-radius: 8px; background: #fffbfd; font-size: 1rem; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent-color); background: #fff; }
        .form-textarea { height: 150px; }

        .poem-full-title { font-family: var(--font-serif); font-size: 2.5rem; margin-bottom: 2rem; color: var(--accent-color); }
        .poem-body { font-family: var(--font-serif); font-size: 1.2rem; line-height: 2; color: var(--text-color); white-space: pre-wrap; text-align: left; }
        .locked-content { filter: blur(8px); opacity: 0.5; user-select: none; }
        .pay-wall { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.95); padding: 2rem; border-radius: 12px; width: 80%; border: 2px solid var(--accent-color); }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="renderPoems()"> <i class="fas fa-feather-alt"></i> Anthology.</div>
    <div class="nav-actions" id="navActions"></div>
</header>

<section class="hero">
    <h1>Versos de Seda y Alma</h1>
    <p>Una colecci√≥n √≠ntima. Reg√≠strate para desbloquear los secretos m√°s profundos.</p>
</section>

<div class="filters">
    <button class="filter-btn active" onclick="filterPoetry('all', this)">Todo</button>
    <button class="filter-btn" onclick="filterPoetry('free', this)">Gratis</button>
    <button class="filter-btn" onclick="filterPoetry('premium', this)">Premium</button>
</div>

<div class="container">
    <div class="grid" id="poetryGrid">
        <p style="text-align:center; width:100%;">Cargando...</p>
    </div>
</div>

<div class="modal-overlay" id="loginModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('loginModal')">&times;</button>
        <h2 class="modal-title">Bienvenido de nuevo</h2>
        <form onsubmit="handleLogin(event)">
            <div class="form-group"><label>Email</label><input type="email" id="loginEmail" class="form-input" required></div>
            <div class="form-group"><label>Contrase√±a</label><input type="password" id="loginPass" class="form-input" required></div>
            <button type="submit" class="btn-solid" style="width:100%">Entrar</button>
        </form>
        <p style="margin-top:1rem; font-size:0.9rem;">¬øNo tienes cuenta? <a href="#" onclick="switchModals('loginModal','registerModal')" style="color:var(--accent-color)">Reg√≠strate</a></p>
    </div>
</div>

<div class="modal-overlay" id="registerModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
        <h2 class="modal-title">Crear Cuenta</h2>
        <form onsubmit="handleRegister(event)">
            <div class="form-group"><label>Nombre</label><input type="text" id="regName" class="form-input" required></div>
            <div class="form-group"><label>Email</label><input type="email" id="regEmail" class="form-input" required></div>
            <div class="form-group"><label>Contrase√±a</label><input type="password" id="regPass" class="form-input" required></div>
            <button type="submit" class="btn-solid" style="width:100%">Registrarse</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="readModal">
    <div class="modal-content wide">
        <button class="close-modal" onclick="closeModal('readModal')">&times;</button>
        <div id="modalContent"></div>
    </div>
</div>

<div class="modal-overlay" id="uploadModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('uploadModal')">&times;</button>
        <h2 class="modal-title">Publicar Poema</h2>
        <form onsubmit="handleUpload(event)">
            <div class="form-group"><label>T√≠tulo</label><input type="text" id="pTitle" class="form-input" required></div>
            <div class="form-group"><label>Contenido</label><textarea id="pBody" class="form-textarea" required></textarea></div>
            <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                <input type="checkbox" id="pPremium" style="width:20px; height:20px; accent-color:var(--accent-color);">
                <label for="pPremium" style="margin:0; cursor:pointer;">¬øEs Premium?</label>
            </div>
            <button type="submit" class="btn-solid" style="width:100%">Publicar</button>
        </form>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN ---
    const API_POEMAS = "http://localhost:8080/api/poesias";
    const API_AUTH = "http://localhost:8080/api/auth";
    const ADMIN_EMAIL = "alvaro19aef@gmail.com";

    let poems = [];
    let currentUser = null;

    // --- 1. RECUPERAR SESI√ìN AL CARGAR (NUEVO) ---
    // Esto se ejecuta apenas carga la p√°gina
    function initSession() {
        const storedUser = localStorage.getItem('versos_user'); // Buscamos si hay algo guardado
        if (storedUser) {
            try {
                currentUser = JSON.parse(storedUser); // Recuperamos el usuario
                console.log("Sesi√≥n restaurada para:", currentUser.nombre);
            } catch (e) {
                console.error("Error al restaurar sesi√≥n", e);
                localStorage.removeItem('versos_user'); // Si est√° corrupto, lo borramos
            }
        }
    }

    // --- FUNCIONES DE AUTENTICACI√ìN ---

    async function handleRegister(e) {
        e.preventDefault();
        const usuario = {
            nombre: document.getElementById('regName').value,
            email: document.getElementById('regEmail').value,
            password: document.getElementById('regPass').value
        };

        try {
            const res = await fetch(`${API_AUTH}/register`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(usuario) });
            if(res.ok) { alert("¬°Cuenta creada! Ahora inicia sesi√≥n."); switchModals('registerModal', 'loginModal'); }
            else { alert("Error: El email ya existe o hubo un fallo."); }
        } catch(err) { console.error(err); alert("Error de conexi√≥n"); }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const credenciales = { email: document.getElementById('loginEmail').value, password: document.getElementById('loginPass').value };

        try {
            const res = await fetch(`${API_AUTH}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(credenciales) });
            const usuario = await res.json(); // Se espera que el backend devuelva el objeto usuario completo (con id, nombre, etc.)

            if(usuario && usuario.id) {
                currentUser = usuario;

                // --- 2. GUARDAR SESI√ìN (NUEVO) ---
                localStorage.setItem('versos_user', JSON.stringify(currentUser));

                closeModal('loginModal');
                updateUI();
                if(currentUser.email === ADMIN_EMAIL){ alert(`¬°Bienvenido Poeta! üñãÔ∏è`); }
                else { alert(`¬°Bienvenido, ${currentUser.nombre}!`); }
            } else { alert("Email o contrase√±a incorrectos."); }
        } catch(err) { console.error(err); alert("Credenciales incorrectas."); }
    }

    function logout() {
        currentUser = null;

        // --- 3. BORRAR SESI√ìN (NUEVO) ---
        localStorage.removeItem('versos_user');

        updateUI();
        alert("Has cerrado sesi√≥n.");
    }

    function upgradeUser() {
        if(!currentUser) return;
        // Simulamos el pago
        if(confirm(`Hola ${currentUser.nombre}, ¬øquieres pagar $5 USD para ser Premium?`)) {
            currentUser.premium = true;

            // --- 4. ACTUALIZAR SESI√ìN (NUEVO) ---
            // Si cambia su estado a Premium, debemos actualizar el localStorage tambi√©n
            localStorage.setItem('versos_user', JSON.stringify(currentUser));

            alert("¬°Pago exitoso! Ahora eres miembro VIP üå∏");
            closeModal('readModal');
            updateUI();
        }
    }

    // --- INTERFAZ DE USUARIO (UI) ---

    function updateUI() {
        const nav = document.getElementById('navActions');
        nav.innerHTML = '';

        if (currentUser) {
            let html = `<span class="user-welcome">Hola, ${currentUser.nombre} ${currentUser.premium ? 'üíé' : ''}</span>`;
            if (currentUser.email === ADMIN_EMAIL) {
                html += `<button class="btn-outline" onclick="openModal('uploadModal')">Escribir</button>`;
            }
            html += `<button class="btn-solid" onclick="logout()">Salir</button>`;
            nav.innerHTML = html;
        } else {
            nav.innerHTML = `<button class="btn-outline" onclick="openModal('loginModal')">Entrar</button> <button class="btn-solid" onclick="openModal('registerModal')">Registrarse</button>`;
        }
        renderPoems(); // Recargar poemas para ver botones de borrar o candados abiertos
    }

    // --- LOGICA DE POEMAS ---

    async function loadPoems() {
        try {
            const res = await fetch(API_POEMAS);
            if(res.ok) { poems = await res.json(); renderPoems(); }
        } catch(err) { console.error(err); }
    }

    async function deletePoem(event, id) {
        event.stopPropagation();
        if(!confirm("¬øEst√°s seguro de que quieres eliminar este poema para siempre?")) return;

        try {
            const res = await fetch(`${API_POEMAS}/${id}`, { method: 'DELETE' });
            if(res.ok) {
                alert("Poema eliminado.");
                loadPoems();
            } else {
                alert("Error al eliminar.");
            }
        } catch(e) { console.error(e); }
    }

    function renderPoems(filter = 'all') {
        const grid = document.getElementById('poetryGrid');
        grid.innerHTML = '';

        const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;

        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

        const filtered = poems.filter(p => {
            if (filter === 'free') return !p.premium;
            if (filter === 'premium') return p.premium;
            return true;
        });

        if(filtered.length === 0) {
            grid.innerHTML = '<p style="color:#999;">No hay poemas en esta secci√≥n.</p>'; return;
        }

        filtered.forEach(poem => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openPoem(poem.id);
            const snippet = poem.body ? poem.body.substring(0, 100).replace(/\n/g, ' ') : "";

            const deleteHtml = isAdmin
                ? `<button class="delete-btn" onclick="deletePoem(event, ${poem.id})" title="Eliminar Poema"><i class="fas fa-trash-alt"></i></button>`
                : '';

            card.innerHTML = `
                <div>
                    <div class="card-tag">
                        <span>${poem.premium ? '<span class="premium-badge"><i class="fas fa-heart"></i> Premium</span>' : 'Gratis'}</span>
                        ${deleteHtml} </div>
                    <h2>${poem.title}</h2>
                    <div class="card-preview">${snippet}...</div>
                </div>
                <div class="card-footer">
                    <span class="read-btn">Leer <i class="fas fa-arrow-right"></i></span>
                    ${poem.premium ? '<i class="fas fa-lock" style="color:var(--accent-color)"></i>' : ''}
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // --- ABRIR POEMA ---
    function openPoem(id) {
        const poem = poems.find(p => p.id === id);
        if(!poem) return;

        const modalContent = document.getElementById('modalContent');
        const isUserAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
        let html = '';

        if (isUserAdmin || !poem.premium) {
            html = buildPoemHtml(poem.title, poem.body);
        } else {
            if (!currentUser) {
                html = buildLockedHtml(poem.title, poem.body, "Inicia sesi√≥n para leer este poema exclusivo.", "openModal('loginModal'); closeModal('readModal')","Iniciar Sesi√≥n");
            } else if (!currentUser.premium) {
                html = buildLockedHtml(poem.title, poem.body, "Este contenido es para miembros VIP.", "upgradeUser()", "Hacerme Premium ($5)");
            } else {
                html = buildPoemHtml(poem.title, poem.body);
            }
        }
        modalContent.innerHTML = html;
        openModal('readModal');
    }

    function buildPoemHtml(title, body) {
        return `<h1 class="poem-full-title">${title}</h1><div class="poem-body">${body}</div><div style="margin-top:3rem; color:var(--accent-color); opacity:0.6"><i class="fas fa-seedling"></i></div>`;
    }

    function buildLockedHtml(title, body, msg, action, btnText) {
        return `<h1 class="poem-full-title"><i class="fas fa-lock" style="opacity:0.5"></i> ${title}</h1><div style="position: relative;"><div class="poem-body locked-content">${body.substring(0, 50)}... <br><br>(El resto se desvanece...)</div><div class="pay-wall"><h3>Contenido Exclusivo</h3><p style="margin-bottom:1rem; color:var(--secondary-color)">${msg}</p><button class="btn-solid" onclick="${action}">${btnText}</button></div></div>`;
    }

    // --- SUBIDA (POST) ---
    async function handleUpload(e) {
        e.preventDefault();
        const poem = { title: document.getElementById('pTitle').value, body: document.getElementById('pBody').value, premium: document.getElementById('pPremium').checked, description: "Anon" };
        await fetch(API_POEMAS, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(poem) });
        closeModal('uploadModal'); document.getElementById('pTitle').value = ""; document.getElementById('pBody').value = ""; loadPoems(); alert("Publicado con √©xito");
    }

    // --- UTILIDADES ---
    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function switchModals(closeId, openId) { closeModal(closeId); openModal(openId); }
    window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('open'); }
    function filterPoetry(type, btn) { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderPoems(type); }

    // --- INICIO ---
    initSession(); // <--- 1. Ejecutar esto primero
    updateUI();    // <--- 2. Actualizar la interfaz
    loadPoems();   // <--- 3. Cargar poemas
</script>

</body>
</html>